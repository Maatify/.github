name: Run Integration Tests

on:
  workflow_dispatch:
  push:
    tags: [ "v*" ]

jobs:
  integration:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    env:
      GH_START_ISO: ${{ github.event.head_commit.timestamp }}
      APP_ENV: testing

      # ----------------------------
      # MySQL
      # ----------------------------
      MYSQL_HOST: 127.0.0.1
      MYSQL_PORT: 3306
      MYSQL_USER: root
      MYSQL_PASS: root
      MYSQL_DB: integration_test

      # ----------------------------
      # Redis
      # ----------------------------
      REDIS_HOST: 127.0.0.1
      REDIS_PORT: 6379

      # ----------------------------
      # Mongo
      # ----------------------------
      MONGO_HOST: 127.0.0.1
      MONGO_PORT: 27017
      MONGO_DB: integration_test

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: integration_test
        ports:
          - "3306:3306"

      redis:
        image: redis:7
        ports:
          - "6379:6379"

      mongo:
        image: mongo:7
        ports:
          - "27017:27017"

    steps:
      # ---------------------------------------------
      # 1) Checkout
      # ---------------------------------------------
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---------------------------------------------
      # 2) PHP Setup
      # ---------------------------------------------
      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          coverage: pcov
          extensions: pdo_mysql, redis, mongodb
          tools: composer

      # ---------------------------------------------
      # 3) Install dependencies
      # ---------------------------------------------
      - run: composer install --no-interaction --prefer-dist --no-progress

      # ---------------------------------------------
      # 4) (OPTIONAL) PHPStan ‚Äî Blocking
      # ---------------------------------------------
      - name: üßπ Run PHPStan (optional)
        run: composer analyse

      # ---------------------------------------------
      # 5) Wait for services
      # ---------------------------------------------
      - name: Wait for MySQL
        run: |
          for i in {1..30}; do
            mysqladmin ping -h $MYSQL_HOST --silent && break
            sleep 2
          done

      # ---------------------------------------------
      # 6) Init Schema
      # ---------------------------------------------
      - name: Init Database Schema
        run: |
          mysql -h $MYSQL_HOST -u$MYSQL_USER -p$MYSQL_PASS $MYSQL_DB < tests/fixtures/schema.sql

      # ---------------------------------------------
      # 7) Run Integration Tests WITH Coverage
      # ---------------------------------------------
      - name: üß™ Run Integration Tests
        run: |
          vendor/bin/phpunit \
            --configuration phpunit.xml.dist \
            --testsuite integration \
            --coverage-clover coverage.xml \
            | tee phpunit-integration.log

      # ---------------------------------------------
      # 8) Extract Coverage %
      # ---------------------------------------------
      - name: Extract Coverage
        id: coverage
        run: |
          COV=$(php -r '
            $x=@simplexml_load_file("coverage.xml");
            if(!$x){echo 0;exit;}
            $m=$x->project->metrics;
            $s=(int)$m["statements"];
            $c=(int)$m["coveredstatements"];
            echo $s>0 ? (int)round(($c/$s)*100) : 0;
          ')
          echo "coverage=$COV" >> $GITHUB_OUTPUT

      # ---------------------------------------------
      # 9) Summary
      # ---------------------------------------------
      - name: üßæ Summary
        if: always()
        run: |
          echo "### üß™ Integration CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "üì¶ Repo: $GITHUB_REPOSITORY" >> $GITHUB_STEP_SUMMARY
          echo "üåø Ref: $GITHUB_REF_NAME" >> $GITHUB_STEP_SUMMARY
          echo "üìä Coverage: ${{ steps.coverage.outputs.coverage }}%" >> $GITHUB_STEP_SUMMARY
          tail -n 20 phpunit-integration.log >> $GITHUB_STEP_SUMMARY || true

      # ---------------------------------------------
      # 10) Telegram Notification
      # ---------------------------------------------
      - name: üì≤ Notify Telegram
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_CI_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CI_CHAT_ID }}
        run: |
          START_TS=$(date -u -d "$GH_START_ISO" +%s)
          END_TS=$(date +%s)
          DURATION=$((END_TS - START_TS))

          if [ $DURATION -lt 60 ]; then
            DURATION_STR="${DURATION}s"
          else
            DURATION_STR="$(($DURATION/60))m $(($DURATION%60))s"
          fi

          STATUS="‚úÖ Integration Passed"
          COLOR="üü¢"
          grep -q "FAILURES!" phpunit-integration.log && STATUS="‚ùå Integration Failed" && COLOR="üî¥"

          MESSAGE="üì¢ <b>Integration CI Report</b>

          ${COLOR} ${STATUS}

          üì¶ <b>Repo:</b> ${GITHUB_REPOSITORY}
          üåø <b>Ref:</b> ${GITHUB_REF_NAME}
          üìä <b>Coverage:</b> ${{ steps.coverage.outputs.coverage }}%
          ‚è≥ <b>Duration:</b> ${DURATION_STR}

          üîó <a href='${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}'>View Logs</a>
          "

          curl -s -X POST \
            "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg chat_id "$TELEGRAM_CHAT_ID" --arg text "$MESSAGE" --arg pm HTML '{chat_id:$chat_id,text:$text,parse_mode:$pm}')"
