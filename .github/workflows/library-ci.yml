name: Maatify Library CI

on:
  workflow_call:
    secrets:
      TELEGRAM_CI_BOT_TOKEN:
        required: true
      TELEGRAM_CI_CHAT_ID:
        required: true

    outputs:
      coverage:
        description: "Coverage percent (push only). Empty on PR."
        value: ${{ jobs.test.outputs.coverage }}

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      coverage: ${{ steps.coverage.outputs.coverage }}

    env:
      GH_START_ISO: ${{ github.event.head_commit.timestamp }}

    strategy:
      matrix:
        php: [ "8.4" ]

    steps:
      - uses: actions/checkout@v4

      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: ~/.composer/cache/files
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          coverage: ${{ github.event_name == 'push' && 'pcov' || 'none' }}
          tools: composer

      - run: composer install --no-interaction --prefer-dist --no-progress

      - name: üßπ Run PHPStan
        id: phpstan
        run: |
          set +e
          composer analyse > phpstan.log
          EXIT_CODE=$?
          ERRORS=$(grep -Eo "Found [0-9]+ errors" phpstan.log | grep -Eo "[0-9]+")
          if [ -z "$ERRORS" ]; then ERRORS=0; fi
          
          echo "phpstan_exit=$EXIT_CODE" >> $GITHUB_OUTPUT
          echo "phpstan_errors=$ERRORS" >> $GITHUB_OUTPUT

      - name: üß™ Run PHPUnit
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            vendor/bin/phpunit \
            --configuration phpunit.xml.dist \
            --coverage-clover coverage.xml \
            | tee phpunit.log
          else
            vendor/bin/phpunit \
              --configuration phpunit.xml.dist
          fi

      - name: Extract Coverage
        id: coverage
        if: github.event_name == 'push'
        run: |
          COV=$(php -r '
            $x=@simplexml_load_file("coverage.xml");
            if(!$x){echo 0;exit;}
            $m=$x->project->metrics;
            $s=(int)$m["statements"];
            $c=(int)$m["coveredstatements"];
            echo $s>0 ? (int)round(($c/$s)*100) : 0;
          ')
          echo "coverage=$COV" >> $GITHUB_OUTPUT

      - name: üßæ Detailed CI Summary
        if: always()
        run: |
          echo "### üßæ Library CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "üì¶ Repository: $GITHUB_REPOSITORY" >> $GITHUB_STEP_SUMMARY
          echo "üåø Branch: $GITHUB_REF_NAME" >> $GITHUB_STEP_SUMMARY
          echo "üêò PHP: ${{ matrix.php }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # PHPUnit
          echo "#### üß™ PHPUnit" >> $GITHUB_STEP_SUMMARY
          if [ -f phpunit.log ]; then
            tail -n 25 phpunit.log >> $GITHUB_STEP_SUMMARY
            if grep -q "FAILURES!" phpunit.log; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "‚ùå Some tests failed." >> $GITHUB_STEP_SUMMARY
            else
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "‚úÖ All tests passed." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "(phpunit.log not found)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # PHPStan
          PHPSTAN_ERR="${{ steps.phpstan.outputs.phpstan_errors }}"
          echo "#### üßπ PHPStan" >> $GITHUB_STEP_SUMMARY
          if [ "$PHPSTAN_ERR" -eq 0 ]; then
            echo "‚úÖ Passed (0 errors)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è ${PHPSTAN_ERR} errors found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            tail -n 20 phpstan.log >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Coverage
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "#### üìä Coverage" >> $GITHUB_STEP_SUMMARY
            echo "Coverage: ${{ steps.coverage.outputs.coverage }}%" >> $GITHUB_STEP_SUMMARY
          else
            echo "#### üìä Coverage" >> $GITHUB_STEP_SUMMARY
            echo "Skipped (PR run)" >> $GITHUB_STEP_SUMMARY
          fi



      - name: üì≤ Notify Telegram
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_CI_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CI_CHAT_ID }}
        run: |
          START_TS=$(date -u -d "$GH_START_ISO" +%s)
          END_TS=$(date +%s)
          DURATION=$((END_TS - START_TS))

          if [ $DURATION -lt 60 ]; then
            DURATION_STR="${DURATION}s"
          else
            DURATION_STR="$(($DURATION/60))m $(($DURATION%60))s"
          fi

          STATUS="‚úÖ Passed"
          COLOR="üü¢"
          [ "${{ job.status }}" != "success" ] && STATUS="‚ùå Failed" && COLOR="üî¥"

          PHPSTAN_ERR=${{ steps.phpstan.outputs.phpstan_errors }}
          if [ "$PHPSTAN_ERR" -eq 0 ]; then
            PHPSTAN_SUMMARY="üßπ <b>PHPStan:</b> Passed (0 errors)"
          else
            PHPSTAN_SUMMARY="üßπ <b>PHPStan:</b> ${PHPSTAN_ERR} errors"
          fi

          MESSAGE="üì¢ <b>Maatify Library CI</b>

          ${COLOR} ${STATUS}

          ${PHPSTAN_SUMMARY}

          üì¶ <b>Repo:</b> ${GITHUB_REPOSITORY}
          üåø <b>Branch:</b> ${GITHUB_REF_NAME}
          üìä <b>Coverage:</b> ${{ steps.coverage.outputs.coverage }}%
          ‚è≥ <b>Duration:</b> ${DURATION_STR}

          üîó <a href='${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}'>View Run</a>
          "

          curl -s -X POST \
            "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg chat_id "$TELEGRAM_CHAT_ID" --arg text "$MESSAGE" --arg pm HTML '{chat_id:$chat_id,text:$text,parse_mode:$pm}')"
